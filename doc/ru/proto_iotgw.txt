	Copyright Unet Global LLC 2017-2018

	Протокол iotgw.

1. Общие сведения.

	Данный протокол определяет язык общения экземпляров ПО IOT Gateway между собой.


X. Детали реализации.
X.1. Отправка запроса другому хосту конфигурации.

	1) Создать объект запроса, выделив ему память в текущем контексте исполнения через механизм memblock, используя статические функции в классе запроса.
	2) Получить указатель на объект класса iot_peer (peer_ptr) соответствующего хосту назначению. Ошибка поиска на данном этапе говорит, что хост мог быть недавно удален
из конфигурации.
	3) Поместить запрос в очередь для отправки, используя peer_ptr->add_packet().
	4) Вызов add_packet вызывает для пакета метод set_queued(), увеличивает счетчик ссылок для пакета  и инициирует (путем посылки асинхронного сигнала в главный
поток) процедуру обработки новых запросов peer_ptr->process_packet_queue().
	5) Процедура process_packet_queue() добавляет имеющиеся в очереди отправки запросы в рабочий список пакетов (работа с этим списком ведется эксклюзивно в главном 
потоке) и далее пытается переложить все пакеты из рабочего списка в очередь текущей активной сессии связи с хостом, если таковая имеется. Если активной сессии нет,
то пакеты в рабочем списке ожидают появления активной сессии (новая сессия пришлет асинхронное уведомления, инициирующее вызов process_packet_queue()).
	6) В случае закрытия сессии шлется асинхронное уведомление в главный поток, по которому необработанные запросы из очереди сессии перемещаются в начало рабочего
списка (т.е. порядок их отправки должен сохранится с учетом возможности поступления новых пакетов). Такая операция может быть выполнена из главного потока, т.к. сессия
уже закрыта, и эксклюзивный доступ к ее данных остается у главного потока, из которого и будет освобождена последняя ссылка на объект сессии (что приведет к освобождению
памяти сессии).
	7) Поток сессии обрабатывает свою очередь в независимом потоке по мере поступления согналов готовности сокета.
	8) На любом этапе до начала физической записи в сокет для отправки для пакета может быть установлен (из любого потока) признак истечения срока актуальности
вызовом для пакета метода set_invalid(). Этот признак может проверяться методом is_valid() на любом из этапов продвижения пакета, описанном а пунктах 4), 5) или 7).
При обнаружении пакета в состоянии invalid, пакет удаляется из очереди, для него вызывается метод reset_queued() и уменьшается его счетчик ссылок.
